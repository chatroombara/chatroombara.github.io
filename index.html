<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6; color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; padding: 20px 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.1em; opacity: 0.9; }
        
        .main-content {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .hidden { display: none; }
        .step { margin: 20px 0; }
        .step h2 { color: #4a90e2; margin-bottom: 15px; text-align: center; }
        
        .auth-section { text-align: center; max-width: 500px; margin: 0 auto; }
        .input-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 16px; text-align: center; direction: ltr;
        }
        input:focus { outline: none; border-color: #4a90e2; }
        
        .btn {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white; border: none; padding: 12px 30px; border-radius: 25px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(74,144,226,0.3); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn.secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .btn.danger { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .btn.success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        
        .error { color: #e74c3c; font-size: 14px; margin: 5px 0; }
        .success { color: #27ae60; font-size: 14px; margin: 5px 0; }
        .info { color: #3498db; font-size: 14px; margin: 5px 0; }
        
        .chat-container { display: flex; height: 600px; }
        .sidebar {
            width: 280px; background: #f8f9fa; border-radius: 15px 0 0 15px; padding: 20px;
            border: 1px solid #eee; display: flex; flex-direction: column;
        }
        .main-chat {
            flex: 1; background: white; border-radius: 0 15px 15px 0;
            border: 1px solid #eee; display: flex; flex-direction: column;
        }
        
        .user-section {
            background: white; border-radius: 10px; padding: 15px; margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .user-info {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
        }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #4a90e2; 
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
        }
        .user-details { flex: 1; }
        .user-name { font-weight: bold; font-size: 14px; }
        .user-status { font-size: 12px; color: #666; }
        
        .user-list { list-style: none; flex: 1; }
        .user-list h4 { margin-bottom: 10px; color: #333; font-size: 14px; }
        .user-item {
            padding: 8px 12px; margin: 5px 0; background: white; border-radius: 8px;
            border: 1px solid #ddd; display: flex; align-items: center; gap: 8px;
        }
        .user-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #27ae60; }
        .user-name { font-weight: bold; color: #333; font-size: 13px; }
        
        .chat-header {
            padding: 15px 20px; background: #f8f9fa; border-radius: 0 15px 0 0;
            border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .chat-title { font-size: 18px; font-weight: bold; color: #333; }
        .connection-status {
            display: flex; align-items: center; gap: 5px; font-size: 14px;
        }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        
        .messages {
            flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa;
            display: flex; flex-direction: column; gap: 15px;
        }
        .message { 
            display: flex; gap: 10px; 
            align-items: flex-start;
        }
        .message.own { flex-direction: row-reverse; }
        .message-avatar {
            width: 35px; height: 35px; border-radius: 50%; background: #4a90e2; 
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;
        }
        .message-content {
            max-width: 70%; 
            display: flex; flex-direction: column;
        }
        .message-bubble {
            padding: 12px 16px; border-radius: 18px; 
            word-wrap: break-word; position: relative;
        }
        .message.own .message-bubble {
            background: linear-gradient(45deg, #4a90e2, #357abd); color: white; 
            border-bottom-left-radius: 5px;
        }
        .message:not(.own) .message-bubble {
            background: white; color: #333; border: 1px solid #ddd;
            border-bottom-right-radius: 5px;
        }
        .message-info {
            display: flex; justify-content: space-between; align-items: center; margin-top: 5px;
            font-size: 11px; opacity: 0.7;
        }
        .message-name {
            font-weight: bold; margin-bottom: 2px;
        }
        .message-time { 
            text-align: left; 
        }
        .message.own .message-time { text-align: right; }
        
        .message-image {
            max-width: 200px; max-height: 200px; border-radius: 12px; margin: 5px 0;
            cursor: pointer; transition: transform 0.2s;
        }
        .message-image:hover {
            transform: scale(1.05);
        }
        
        .message-input {
            padding: 20px; background: white; border-top: 1px solid #eee; border-radius: 0 0 15px 0;
            display: flex; gap: 10px; align-items: flex-end;
        }
        .input-container {
            flex: 1; display: flex; flex-direction: column; gap: 10px;
        }
        .input-wrapper {
            display: flex; gap: 10px; align-items: flex-end;
        }
        .message-input-field {
            flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 12px 16px; 
            text-align: right; resize: none; min-height: 40px; max-height: 120px;
        }
        .attachment-buttons {
            display: flex; gap: 5px; margin-bottom: 5px;
        }
        .attachment-btn {
            background: #f8f9fa; border: 1px solid #ddd; border-radius: 50%; 
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.2s;
        }
        .attachment-btn:hover { background: #e9ecef; transform: scale(1.1); }
        .attachment-btn input { display: none; }
        .send-btn { border-radius: 20px; padding: 12px 20px; }
        
        .verification-section {
            background: #e8f5e8; padding: 20px; border-radius: 12px; margin: 20px 0;
            border: 1px solid #d4edda;
        }
        .otp-display {
            font-size: 20px; font-weight: bold; text-align: center; margin: 15px 0;
            background: white; padding: 15px; border-radius: 8px; border: 2px dashed #27ae60;
            font-family: 'Courier New', monospace; letter-spacing: 2px;
        }
        .otp-timer {
            text-align: center; color: #e74c3c; font-weight: bold; margin: 10px 0;
        }
        .sms-status {
            text-align: center; padding: 10px; border-radius: 8px; margin: 10px 0;
        }
        .sms-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sms-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .image-preview {
            max-width: 200px; max-height: 200px; border-radius: 12px; margin: 10px;
            border: 2px solid #4a90e2;
        }
        
        .loading { 
            display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; 
            border-top: 2px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .scrollable { overflow-y: auto; max-height: 100%; }
        
        .sms-settings {
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6;
        }
        .sms-settings h4 { margin-bottom: 10px; color: #333; }
        .sms-option {
            margin: 10px 0; display: flex; align-items: center; gap: 10px;
        }
        .sms-option input[type="radio"] { width: auto; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’¬ Ú†Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>
            <div class="subtitle">Ø§Ø±Ø³Ø§Ù„ SMS ÙˆØ§Ù‚Ø¹ÛŒ + Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ + Ú†Øª Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯</div>
        </header>

        <div class="main-content">
            <!-- Ø¨Ø®Ø´ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª -->
            <div id="authSection" class="auth-section">
                <div class="step">
                    <h2>ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</h2>
                    
                    <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ SMS -->
                    <div class="sms-settings">
                        <h4>ğŸ“± Ø±ÙˆØ´ Ø§Ø±Ø³Ø§Ù„ SMS:</h4>
                        <div class="sms-option">
                            <input type="radio" id="smsDemo" name="smsMethod" value="demo" checked>
                            <label for="smsDemo">ğŸ”§ Ø¯Ù…Ùˆ (Ø±Ø§ÛŒÚ¯Ø§Ù† - Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ API)</label>
                        </div>
                        <div class="sms-option">
                            <input type="radio" id="smsTwilio" name="smsMethod" value="twilio">
                            <label for="smsTwilio">ğŸŒ Twilio API (ÙˆØ§Ù‚Ø¹ÛŒ - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø­Ø³Ø§Ø¨)</label>
                        </div>
                        <div class="sms-option">
                            <input type="radio" id="smsIran" name="smsMethod" value="iran">
                            <label for="smsIran">ğŸ‡®ğŸ‡· Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ (Ù‡Ø± Ø³Ù‡ - Ú©Ø§ÙÙ‡â€ŒØ¨Ø§Ø²Ø§Ø± - Ù…Ù„Øª)</label>
                        </div>
                    </div>
                    
                    <div id="phoneStep">
                        <div class="input-group">
                            <label for="phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§ÛŒØ±Ø§Ù†ÛŒ:</label>
                            <input type="text" id="phone" placeholder="09123456789" maxlength="11" dir="ltr">
                            <div id="phoneError" class="error"></div>
                        </div>
                        <button id="sendCodeBtn" class="btn">ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
                        <div id="smsStatus"></div>
                    </div>
                    
                    <div id="codeStep" class="hidden">
                        <div class="verification-section">
                            <h3>ğŸ“± Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§:</h3>
                            <div id="otpDisplay" class="otp-display">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...</div>
                            <div id="otpTimer" class="otp-timer hidden">Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: 60 Ø«Ø§Ù†ÛŒÙ‡</div>
                        </div>
                        <div class="input-group">
                            <label for="verificationCode">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯:</label>
                            <input type="text" id="verificationCode" placeholder="123456" maxlength="6" dir="ltr">
                            <div id="codeError" class="error"></div>
                        </div>
                        <button id="verifyBtn" class="btn">âœ… ØªØ§ÛŒÛŒØ¯ Ú©Ø¯</button>
                        <button id="resendCodeBtn" class="btn secondary">ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯</button>
                    </div>
                    
                    <div id="nameStep" class="hidden">
                        <div class="input-group">
                            <label for="userName">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                            <input type="text" id="userName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
                            <div id="nameError" class="error"></div>
                        </div>
                        <button id="loginBtn" class="btn success">ğŸš€ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</button>
                    </div>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Ú†Øª -->
            <div id="chatSection" class="hidden">
                <div class="chat-container">
                    <div class="sidebar">
                        <div class="user-section">
                            <div class="user-info">
                                <div class="user-avatar" id="currentUserAvatar">UN</div>
                                <div class="user-details">
                                    <div class="user-name" id="currentUserName">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±</div>
                                    <div class="user-status">Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
                                </div>
                            </div>
                            <button id="logoutBtn" class="btn danger" style="width: 100%;">ğŸšª Ø®Ø±ÙˆØ¬</button>
                        </div>
                        
                        <div class="user-list scrollable">
                            <h4>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† (<span id="onlineCount">1</span>)</h4>
                            <div id="onlineUsers"></div>
                            <h4 style="margin-top: 20px;">ğŸ’¤ Ø¢ÙÙ„Ø§ÛŒÙ†â€ŒÙ‡Ø§ (<span id="offlineCount">0</span>)</h4>
                            <div id="offlineUsers"></div>
                        </div>
                    </div>
                    
                    <div class="main-chat">
                        <div class="chat-header">
                            <div class="chat-title">ğŸ’¬ Ú†Øª Ú¯Ø±ÙˆÙ‡ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</div>
                            <div class="connection-status">
                                <div id="connectionIndicator" class="status-indicator status-online"></div>
                                <span id="connectionText">Ù…ØªØµÙ„</span>
                            </div>
                        </div>
                        
                        <div id="messages" class="messages"></div>
                        
                        <div class="message-input">
                            <div class="input-container">
                                <div class="attachment-buttons">
                                    <label class="attachment-btn" title="Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³">
                                        ğŸ–¼ï¸
                                        <input type="file" id="imageInput" accept="image/*">
                                    </label>
                                    <div class="attachment-btn" title="Ø§ÛŒÙ…ÙˆØ¬ÛŒ">
                                        ğŸ˜Š
                                    </div>
                                </div>
                                
                                <div class="input-wrapper">
                                    <textarea 
                                        id="messageInput" 
                                        class="message-input-field" 
                                        placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯..." 
                                        rows="1"
                                    ></textarea>
                                    <button id="sendBtn" class="btn send-btn">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdvancedChatApp {
            constructor() {
                this.currentUser = null;
                this.messages = [];
                this.isConnected = true;
                this.otpCode = null;
                this.otpTimer = null;
                this.otpExpiryTime = null;
                
                // API ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯)
                this.smsConfig = {
                    twilio: {
                        accountSid: 'YOUR_TWILIO_ACCOUNT_SID', // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
                        authToken: 'YOUR_TWILIO_AUTH_TOKEN',   // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
                        from: 'YOUR_TWILIO_PHONE'             // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯
                    },
                    iranServices: {
                        hamkhan: { apiKey: 'YOUR_API_KEY' },
                        kafebazar: { apiKey: 'YOUR_API_KEY' },
                        melat: { apiKey: 'YOUR_API_KEY' }
                    }
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadExistingMessages();
                this.updateUserList();
                this.loadCurrentUser();
                
                // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù‡Ø± 2 Ø«Ø§Ù†ÛŒÙ‡
                setInterval(() => {
                    this.loadExistingMessages();
                    this.updateUserList();
                }, 2000);
            }
            
            setupEventListeners() {
                // Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ SMS
                document.querySelectorAll('input[name="smsMethod"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        this.updateSmsStatus();
                    });
                });
                
                // Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯
                document.getElementById('sendCodeBtn').addEventListener('click', () => {
                    this.sendVerificationCode();
                });
                
                // Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯
                document.getElementById('resendCodeBtn').addEventListener('click', () => {
                    this.sendVerificationCode();
                });
                
                // Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ú©Ø¯
                document.getElementById('verifyBtn').addEventListener('click', () => {
                    this.verifyCode();
                });
                
                // Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯
                document.getElementById('loginBtn').addEventListener('click', () => {
                    this.login();
                });
                
                // Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });
                
                // Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
                document.getElementById('sendBtn').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Enter
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³
                document.getElementById('imageInput').addEventListener('change', (e) => {
                    this.handleImageUpload(e);
                });
                
                // auto-resize textarea
                document.getElementById('messageInput').addEventListener('input', (e) => {
                    this.autoResizeTextarea(e.target);
                });
            }
            
            updateSmsStatus() {
                const selectedMethod = document.querySelector('input[name="smsMethod"]:checked').value;
                const statusEl = document.getElementById('smsStatus');
                
                switch(selectedMethod) {
                    case 'demo':
                        statusEl.innerHTML = '<div class="info">ğŸ”§ Ø§Ø² Ø±ÙˆØ´ Ø¯Ù…Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ - Ú©Ø¯: 123456</div>';
                        break;
                    case 'twilio':
                        statusEl.innerHTML = '<div class="info">ğŸŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… API Twilio Ø¯Ø± Ú©Ø¯</div>';
                        break;
                    case 'iran':
                        statusEl.innerHTML = '<div class="info">ğŸ‡®ğŸ‡· Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… API Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ Ø¯Ø± Ú©Ø¯</div>';
                        break;
                }
            }
            
            validateIranianPhone(phone) {
                const phoneRegex = /^09[0-9]{9}$/;
                return phoneRegex.test(phone);
            }
            
            generateOtpCode() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }
            
            async sendVerificationCode() {
                const phone = document.getElementById('phone').value.trim();
                const errorEl = document.getElementById('phoneError');
                const smsStatusEl = document.getElementById('smsStatus');
                
                if (!this.validateIranianPhone(phone)) {
                    errorEl.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø§ÛŒØ±Ø§Ù†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 09123456789)';
                    return;
                }
                
                errorEl.textContent = '';
                
                const selectedMethod = document.querySelector('input[name="smsMethod"]:checked').value;
                
                // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
                smsStatusEl.innerHTML = '<div class="info">â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯...</div>';
                
                // ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ OTP
                this.otpCode = this.generateOtpCode();
                this.otpExpiryTime = Date.now() + (5 * 60 * 1000); // 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±
                
                try {
                    let smsSuccess = false;
                    
                    switch(selectedMethod) {
                        case 'demo':
                            smsSuccess = await this.sendDemoSms(phone);
                            break;
                        case 'twilio':
                            smsSuccess = await this.sendTwilioSms(phone);
                            break;
                        case 'iran':
                            smsSuccess = await this.sendIranianSms(phone);
                            break;
                    }
                    
                    if (smsSuccess) {
                        smsStatusEl.innerHTML = '<div class="sms-status sms-success">âœ… Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!</div>';
                        this.showOtpStep();
                    } else {
                        smsStatusEl.innerHTML = '<div class="sms-status sms-error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ SMS. Ø§Ø² Ø±ÙˆØ´ Ø¯Ù…Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>';
                        // fallback Ø¨Ù‡ Ø¯Ù…Ùˆ
                        this.otpCode = '123456';
                        this.showOtpStep();
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ SMS:', error);
                    smsStatusEl.innerHTML = '<div class="sms-status sms-error">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ SMS. Ø§Ø² Ø±ÙˆØ´ Ø¯Ù…Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>';
                    this.otpCode = '123456';
                    this.showOtpStep();
                }
            }
            
            async sendDemoSms(phone) {
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ SMS Ø¯Ø± Ø¯Ù…Ùˆ
                await new Promise(resolve => setTimeout(resolve, 1000));
                console.log('Ø¯Ù…Ùˆ SMS Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ù‡:', phone, 'Ú©Ø¯:', this.otpCode);
                return true;
            }
            
            async sendTwilioSms(phone) {
                // TODO: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Twilio API
                // Ø§ÛŒÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Twilio SDK Ùˆ ØªÙ†Ø¸ÛŒÙ… API keys Ø¯Ø§Ø±Ø¯
                console.log('Twilio SMS Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… API Ø¯Ø§Ø±Ø¯');
                return false;
            }
            
            async sendIranianSms(phone) {
                // TODO: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ
                console.log('Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ… API Ø¯Ø§Ø±Ø¯');
                return false;
            }
            
            showOtpStep() {
                document.getElementById('phoneStep').classList.add('hidden');
                document.getElementById('codeStep').classList.remove('hidden');
                
                // Ù†Ù…Ø§ÛŒØ´ Ú©Ø¯
                document.getElementById('otpDisplay').textContent = this.otpCode;
                
                // Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø±
                this.startOtpTimer();
            }
            
            startOtpTimer() {
                const timerEl = document.getElementById('otpTimer');
                timerEl.classList.remove('hidden');
                
                this.otpTimer = setInterval(() => {
                    const remainingTime = this.otpExpiryTime - Date.now();
                    
                    if (remainingTime <= 0) {
                        clearInterval(this.otpTimer);
                        timerEl.textContent = 'Ú©Ø¯ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù†ÛŒØ¯.';
                        return;
                    }
                    
                    const minutes = Math.floor(remainingTime / 60000);
                    const seconds = Math.floor((remainingTime % 60000) / 1000);
                    timerEl.textContent = `Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
            
            verifyCode() {
                const code = document.getElementById('verificationCode').value.trim();
                const errorEl = document.getElementById('codeError');
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ú©Ø¯
                if (Date.now() > this.otpExpiryTime) {
                    errorEl.textContent = 'Ú©Ø¯ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù†ÛŒØ¯.';
                    return;
                }
                
                if (code !== this.otpCode) {
                    errorEl.textContent = 'Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.';
                    return;
                }
                
                errorEl.textContent = '';
                document.getElementById('codeStep').classList.add('hidden');
                document.getElementById('nameStep').classList.remove('hidden');
                
                // ØªÙˆÙ‚Ù ØªØ§ÛŒÙ…Ø±
                if (this.otpTimer) {
                    clearInterval(this.otpTimer);
                }
            }
            
            login() {
                const name = document.getElementById('userName').value.trim();
                const errorEl = document.getElementById('nameError');
                
                if (name.length < 2) {
                    errorEl.textContent = 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
                    return;
                }
                
                errorEl.textContent = '';
                
                // Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±
                const phone = document.getElementById('phone').value.trim();
                this.currentUser = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    name: name,
                    phone: phone,
                    avatar: this.generateAvatar(name),
                    online: true
                };
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
                localStorage.setItem('chatUser', JSON.stringify(this.currentUser));
                this.saveUserToList();
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ú†Øª
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('chatSection').classList.remove('hidden');
                
                // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±
                this.updateCurrentUserDisplay();
                
                // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®ÙˆØ´Ø§Ù…Ø¯Ú¯ÙˆÛŒÛŒ
                this.sendSystemMessage(`${name} Ø¨Ù‡ Ú†Øª Ù¾ÛŒÙˆØ³Øª`);
            }
            
            logout() {
                if (this.currentUser) {
                    this.sendSystemMessage(`${this.currentUser.name} Ø§Ø² Ú†Øª Ø®Ø§Ø±Ø¬ Ø´Ø¯`);
                    this.currentUser.online = false;
                    this.saveUserToList();
                }
                
                localStorage.removeItem('chatUser');
                this.currentUser = null;
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                document.getElementById('chatSection').classList.add('hidden');
                document.getElementById('authSection').classList.remove('hidden');
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                document.getElementById('phone').value = '';
                document.getElementById('verificationCode').value = '';
                document.getElementById('userName').value = '';
            }
            
            updateCurrentUserDisplay() {
                if (this.currentUser) {
                    document.getElementById('currentUserAvatar').textContent = this.currentUser.avatar;
                    document.getElementById('currentUserName').textContent = this.currentUser.name;
                }
            }
            
            loadCurrentUser() {
                const storedUser = localStorage.getItem('chatUser');
                if (storedUser) {
                    this.currentUser = JSON.parse(storedUser);
                    this.updateCurrentUserDisplay();
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ú†Øª
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('chatSection').classList.remove('hidden');
                }
            }
            
            generateAvatar(name) {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            }
            
            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            async handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„
                if (!file.type.startsWith('image/')) {
                    alert('ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯');
                    return;
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙØ§ÛŒÙ„ (Ø­Ø¯Ø§Ú©Ø«Ø± 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯');
                    return;
                }
                
                // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ base64
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    this.sendImageMessage(imageData, file.name);
                };
                reader.readAsDataURL(file);
            }
            
            sendImageMessage(imageData, fileName) {
                if (!this.currentUser) return;
                
                const message = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    type: 'image',
                    text: imageData,
                    fileName: fileName,
                    sender: this.currentUser.name,
                    senderId: this.currentUser.id,
                    timestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.saveMessages();
                this.renderMessages();
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† input
                document.getElementById('imageInput').value = '';
            }
            
            sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const text = messageInput.value.trim();
                
                if (!text || !this.currentUser) return;
                
                const message = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    type: 'text',
                    text: text,
                    sender: this.currentUser.name,
                    senderId: this.currentUser.id,
                    timestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.saveMessages();
                this.renderMessages();
                
                messageInput.value = '';
                this.autoResizeTextarea(messageInput);
            }
            
            sendSystemMessage(text) {
                const message = {
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    type: 'system',
                    text: text,
                    sender: 'Ø³ÛŒØ³ØªÙ…',
                    senderId: 'system',
                    timestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.saveMessages();
                this.renderMessages();
            }
            
            loadExistingMessages() {
                const storedMessages = localStorage.getItem('chatMessages');
                if (storedMessages) {
                    this.messages = JSON.parse(storedMessages);
                    this.renderMessages();
                }
            }
            
            saveMessages() {
                localStorage.setItem('chatMessages', JSON.stringify(this.messages));
            }
            
            saveUserToList() {
                if (!this.currentUser) return;
                
                const users = this.getAllUsers();
                const existingIndex = users.findIndex(u => u.id === this.currentUser.id);
                
                if (existingIndex >= 0) {
                    users[existingIndex] = this.currentUser;
                } else {
                    users.push(this.currentUser);
                }
                
                localStorage.setItem('chatUsers', JSON.stringify(users));
            }
            
            getAllUsers() {
                const storedUsers = localStorage.getItem('chatUsers');
                return storedUsers ? JSON.parse(storedUsers) : [];
            }
            
            renderMessages() {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                this.messages.forEach(message => {
                    const messageEl = this.createMessageElement(message);
                    messagesContainer.appendChild(messageEl);
                });
                
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            createMessageElement(message) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.senderId === this.currentUser?.id ? 'own' : 'other'}`;
                
                // Ø¢ÙˆØ§ØªØ§Ø±
                const avatarEl = document.createElement('div');
                avatarEl.className = 'message-avatar';
                avatarEl.textContent = this.generateAvatar(message.sender);
                messageEl.appendChild(avatarEl);
                
                // Ù…Ø­ØªÙˆØ§
                const contentEl = document.createElement('div');
                contentEl.className = 'message-content';
                
                const bubbleEl = document.createElement('div');
                bubbleEl.className = 'message-bubble';
                
                if (message.type === 'image') {
                    const imgEl = document.createElement('img');
                    imgEl.src = message.text;
                    imgEl.className = 'message-image';
                    imgEl.onclick = () => this.showFullImage(message.text);
                    bubbleEl.appendChild(imgEl);
                } else if (message.type === 'system') {
                    const systemEl = document.createElement('div');
                    systemEl.style.textAlign = 'center';
                    systemEl.style.fontStyle = 'italic';
                    systemEl.style.color = '#666';
                    systemEl.textContent = message.text;
                    bubbleEl.appendChild(systemEl);
                } else {
                    const textEl = document.createElement('div');
                    textEl.textContent = message.text;
                    bubbleEl.appendChild(textEl);
                }
                
                contentEl.appendChild(bubbleEl);
                
                // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ§Ù… (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±)
                if (message.type !== 'system') {
                    const infoEl = document.createElement('div');
                    infoEl.className = 'message-info';
                    
                    const nameEl = document.createElement('div');
                    nameEl.className = 'message-name';
                    nameEl.textContent = message.sender;
                    infoEl.appendChild(nameEl);
                    
                    const timeEl = document.createElement('div');
                    timeEl.className = 'message-time';
                    timeEl.textContent = this.formatTime(message.timestamp);
                    infoEl.appendChild(timeEl);
                    
                    contentEl.appendChild(infoEl);
                }
                
                messageEl.appendChild(contentEl);
                return messageEl;
            }
            
            showFullImage(src) {
                // Ù†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø¯Ø± Ø­Ø§Ù„Øª Ø¨Ø²Ø±Ú¯
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
                overlay.style.display = 'flex';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.zIndex = '1000';
                overlay.style.cursor = 'pointer';
                
                const img = document.createElement('img');
                img.src = src;
                img.style.maxWidth = '90%';
                img.style.maxHeight = '90%';
                img.style.borderRadius = '10px';
                
                overlay.appendChild(img);
                overlay.onclick = () => document.body.removeChild(overlay);
                
                document.body.appendChild(overlay);
            }
            
            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('fa-IR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            
            updateUserList() {
                const users = this.getAllUsers();
                const onlineUsers = users.filter(u => u.online);
                const offlineUsers = users.filter(u => !u.online);
                
                // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯
                document.getElementById('onlineCount').textContent = onlineUsers.length;
                document.getElementById('offlineCount').textContent = offlineUsers.length;
                
                // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
                const onlineList = document.getElementById('onlineUsers');
                onlineList.innerHTML = '';
                
                onlineUsers.forEach(user => {
                    const userEl = this.createUserElement(user);
                    onlineList.appendChild(userEl);
                });
                
                // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢ÙÙ„Ø§ÛŒÙ†
                const offlineList = document.getElementById('offlineUsers');
                offlineList.innerHTML = '';
                
                offlineUsers.forEach(user => {
                    const userEl = this.createUserElement(user);
                    offlineList.appendChild(userEl);
                });
            }
            
            createUserElement(user) {
                const userEl = document.createElement('div');
                userEl.className = 'user-item';
                
                const statusDot = document.createElement('div');
                statusDot.className = `user-status-dot ${user.online ? 'status-online' : 'status-offline'}`;
                userEl.appendChild(statusDot);
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.width = '25px';
                avatar.style.height = '25px';
                avatar.style.fontSize = '10px';
                avatar.textContent = this.generateAvatar(user.name);
                userEl.appendChild(avatar);
                
                const name = document.createElement('div');
                name.className = 'user-name';
                name.textContent = user.name;
                userEl.appendChild(name);
                
                return userEl;
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
        document.addEventListener('DOMContentLoaded', () => {
            new AdvancedChatApp();
        });
    </script>
</body>
</html>
